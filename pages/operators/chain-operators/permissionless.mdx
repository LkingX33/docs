---
title: Migrating to permissionless fault proofs on OP Stack
description: A high-level guide for transitioning from permissioned to permissionless fault proofs on an OP Stack.
lang: en-US
content_type: tutorial
topic: running-a-local-development-environment
personas:
  - chain-operator
categories:
  - testnet
  - local-devnet
  - chain-deployment
  - docker
  - chain-configuration
  - chain-operation
  - node-management
is_imported_content: 'false'
---

# Transitioning from permissioned to permissionless proofs in OP Stack

This guide provides a high-level overview for chain operators looking to transition their OP Stack from permissioned to permissionless fault proofs. It's designed to be accessible for technical decision makers while providing sufficient detail for implementation teams.

## Overview

The OP Stack architecture uses fault proofs to ensure the validity of transactions processed on Layer 2. Transitioning from permissioned to permissionless proofs represents a significant security upgrade, allowing any participant to challenge invalid state transitions rather than relying on a limited set of trusted validators.

This migration involves several key components:

*   Configuring security-critical dispute monitoring services
*   Deploying and configuring smart contracts
*   Testing the new system before activation
*   Switching the chain to use the new permissionless system

## Prerequisites

Before beginning this transition, your chain should:

*   Be running a standard OP Stack implementation
*   Have a functioning permissioned proof system
*   Be operating with the recommended infrastructure components including `op-challenger` and `op-dispute-mon`

## 1. Configure the dispute monitoring stack

The `op-challenger` and `op-dispute-mon` services are critical security components that participate in the dispute game process to challenge invalid proposals.

### Upgrade to the latest `op-challenger`

Upgrade to version 1.3.2 or later, which contains important improvements to simplify the upgrade process.

```bash
# Example upgrade command (implementation may vary based on your deployment)
git clone https://github.com/ethereum-optimism/optimism -b op-challenger/v1.3.2 --recurse-submodules
cd optimism
make op-challenger
```

### Update network configuration

Configure `op-challenger` to load your chain configuration. If your chain is included in the superchain-registry, use:

```bash
--network <chain-name>
```

### Enable cannon trace type

Configure `op-challenger` to support both permissioned and permissionless games by setting:

```bash
--trace-type permissioned,cannon
```

Or by setting the environment variable:

```
OP_CHALLENGER_TRACE_TYPE=permissioned,cannon
```

### Configure prestates access

Replace the `--cannon-prestate` flag with `--prestates-url`, which points to a source containing all required prestates:

```bash
--prestates-url <URL_TO_PRESTATES_DIRECTORY>
```

The URL can use `http`, `https`, or `file` protocols. Each prestate should be named as `<PRESTATE_HASH>.json` or `<PRESTATE_HASH>.bin.gz`.

### Building required prestates

You'll need at least two prestates:

1.  The prestate used for permissioned games
2.  The prestate matching the `faultGameAbsolutePrestate` configuration

To build prestates for all tagged releases:

```bash
git clone https://github.com/ethereum-optimism/optimism --recurse-submodules
cd optimism
./op-program/scripts/build-prestates.sh
```

To build a specific prestate (e.g., for op-program/v1.3.1):

```bash
git clone https://github.com/ethereum-optimism/optimism -b op-program/v1.3.1 --recurse-submodules
cd optimism
make reproducible-prestate
```

The prestate will be generated at `op-program/bin/prestate.json` (or `prestate.bin.gz` for newer versions).

### Ensure sufficient funds for bonds

Unlike with permissioned games, the challenger will need to post bonds with each claim it makes. As a general guideline:

*   Maintain a minimum balance of 50 ETH
*   Have access to a large pool of ETH for potential attack scenarios
*   Implement monitoring to ensure sufficient funds are always available

### Set Up `op-dispute-mon`

Ensure `op-dispute-mon` is properly configured according to:

*   [Optimism Documentation](https://docs.optimism.io/operators/chain-operators/tools/chain-monitoring#dispute-mon)
*   [GitHub Repository](https://github.com/ethereum-optimism/optimism/tree/develop/op-dispute-mon)

## 2. Deploy and configure smart contracts

This section requires privileged actions by the `ProxyAdminOwner`.

### Set game implementations

The following smart contract changes must be made:

1.  Call `setImplementation` on the `DisputeGameFactoryProxy` to:
    *   Set the implementation for the new permissionless `FaultDisputeGame` (game type `0`)
    *   Upgrade the permissioned game to the new `PermissionedDisputeGameAddress` (game type `1`) with the updated absolute prestate

2.  Upgrade the `AnchorStateRegistryProxy`:
    *   First upgrade to point to the `StorageSetter` contract and clear the initialized flag
    *   Then upgrade back to the `AnchorStateRegistry` implementation
    *   Call `initialize` with the anchor state for the new game type

3.  Initialize bond amounts for each game type to 0.08 ETH

The anchor state for permissionless games should match the current anchor state for permissioned games at the time of migration.

## 3. Testing off-chain agents

Before enabling permissionless proofs for withdrawals, thoroughly test your off-chain monitoring services.

### Test defending valid proposals

Create a valid proposal using the permissionless game type `0`:

1.  Ensure the proposal is from a block at or before the `safe` head:
    ```bash
    cast block --rpc-url <OP_GETH_ENDPOINT> safe
    ```

2.  Get a valid output root:
    ```bash
    cast rpc --rpc-url <OP_NODE_ENDPOINT> optimism_outputAtBlock \
      $(cast 2h <BLOCK_NUMBER>) | jq -r .outputRoot
    ```

3.  Create a test game:
    ```bash
    ./op-challenger/bin/op-challenger create-game \
      --l1-eth-rpc=<L1_RPC_ENDPOINT> \
      --game-factory-address <DISPUTE_GAME_FACTORY_ADDR> \
      --l2-block-num <BLOCK_NUMBER> \
      --output-root <OUTPUT_ROOT> \
      <SIGNER_OPTIONS>
    ```

4.  Verify:
    *   `op-challenger` logs a message showing the game is in progress
    *   `op-challenger` doesn't post a counter claim (as this is a valid proposal)
    *   `dispute-mon` includes the new game with `status="agree_defender_ahead"`

### Test countering invalid claims

Post an invalid counter claim to the valid proposal created above:

```bash
./op-challenger/bin/op-challenger move \
  --l1-eth-rpc <L1_RPC_ENDPOINT> \
  --game-address <GAME_ADDR> \
  --attack \
  --parent-index 0 \
  --claim 0x0000000000000000000000000000000000000000000000000000000000000000 \
  <SIGNER_OPTIONS>
```

Verify that `op-challenger` posts a counter-claim to the invalid claim. You can view claims using:

```bash
./op-challenger/bin/op-challenger list-claims \
  --l1-eth-rpc <L1_RPC_ENDPOINT> \
  --game-address <GAME_ADDR>
```

There should be 3 claims in the game after this test.

## 4. Switch to permissionless proofs

After completing all previous steps and verifying their successful operation:

1.  Set the `respectedGameType` on the `OptimismPortal` to `CANNON` (game type `0`)

2.  Configure `op-proposer` to create proposals using the permissionless `cannon` game type:

    ```bash
    # Change from game-type 1 to 0
    --game-type 0
    ```

    Or via environment variable:

    ```
    OP_PROPOSER_GAME_TYPE=0
    ```

## Next steps

*   [Optimism Fault Proof Documentation](https://docs.optimism.io/builders/chain-operators/tools/op-challenger)
*   [Privileged Roles Documentation](https://docs.optimism.io/chain/security/privileged-roles)
*   [L2Beat OP Mainnet Upgrades](https://l2beat.com/scaling/projects/op-mainnet#upgrades-and-governance)
*   [op-challenger GitHub](https://github.com/ethereum-optimism/optimism/tree/develop/op-challenger)
*   [op-dispute-mon GitHub](https://github.com/ethereum-optimism/optimism/tree/develop/op-dispute-mon)

## Conclusion

Transitioning to permissionless proofs represents a significant security improvement for your OP Stack chain. This transition decentralizes the validation process, allowing any participant to challenge invalid state transitions rather than relying on a limited set of trusted validators.

By following this guide, you'll be able to safely configure and test your system before making the final switch to permissionless proofs. Remember to thoroughly test each component before proceeding to the next step, and ensure that your security monitoring is properly configured to track the health of the system after the transition.
